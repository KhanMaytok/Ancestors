NAMESPACE = ACS

# ACS.400 - Get into duel
character_event = {
    id = ACS.400
    desc = EVTDESC_ACS_400
	picture = GFX_evt_melee
	border = GFX_event_normal_frame_war
	is_triggered_only = yes

	immediate = {
		random_friend = {
			limit = {
				has_character_flag = wants_to_get_mangekyo
			}
			set_character_flag = mangekyo_immediate
			save_event_target_as = target_wants_to_get_mangekyo			
		}
	}

    option = {
    	name = EVTOPTB_ACS_400
    	ai_chance = {
    		factor = 100
    	}
    	event_target:target_wants_to_get_mangekyo = {
			set_character_flag = mangekyo_option
    		character_event = { id = ACS.401 }
    	}
    }
}

# ACS.401 - The duel starts
character_event = {
    id = ACS.401
    hide_window = yes
    is_triggered_only = yes

    immediate = {
    	log = "ACS.401: [Root.GetBestName] challenged [From.GetBestName] on a duel"
    	random_list = {
			1 = { # double death
				modifier = {
					OR = {
						combat_rating_diff = { who = FROM value = 4 }
						FROM = { combat_rating_diff = { who = ROOT value = 4 } }
					}
					factor = 0.2
				}
				modifier = {
					trait = wroth
					FROM = {
						trait = wroth
					}
					factor = 2
				}
				FROM = {
					death = {
						death_reason = death_duel killer = ROOT
					}
				}
				death = {
					death_reason = death_duel killer = FROM
				}
			}
			200 = {
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 1 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 2 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 3 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 4 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 5 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 6 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 7 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 8 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 9 }
					}
					factor = 0.7
				}
				modifier = {
					FROM = {
						combat_rating_diff = { who = ROOT value = 10 }
					}
					factor = 0.7
				}
				### effects
				random_list = {
					95 = {
						FROM = {
							death = {
								death_reason = death_murder_unknown killer = ROOT
							}
						}
						remove_trait = sharingan
						add_trait = mangekyo_sharingan
						add_trait=stressed
						clr_character_flag = wants_to_get_mangekyo
						character_event = { id = ACS.402 }
					}
					5 = {
						modifier = {
							FROM = { is_maimed_trigger = yes }
							factor = 0
						}
						FROM = {
							death = {
								death_reason = death_murder_unknown killer = ROOT
							}
						}
						remove_trait = sharingan
						add_trait = mangekyo_sharingan
						add_trait = stressed
						clr_character_flag = wants_to_get_mangekyo
						character_event = { id = ACS.402 }
						random_list = {
							30 = { add_trait = disfigured }
							30 = { add_trait = one_eyed }
							30 = { add_trait = one_handed }
							10 = { add_trait = severely_injured }
						}
					}
				}
			}
			200 = { # opponent win
				### modifiers
				#modifier = {
				#	factor = 0
				#	always = yes ######### DEBUGGING
				#}
				modifier = {
					combat_rating_diff = { who = FROM value = 1 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 2 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 3 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 4 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 5 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 6 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 7 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 8 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 9 }
					factor = 0.7
				}
				modifier = {
					combat_rating_diff = { who = FROM value = 10 }
					factor = 0.7
				}
				### effects
				random_list = {
					50 = {
						FROM = {
							clr_character_flag = target_for_mangekyo
						}
						death = {
							death_reason = death_murder_unknown killer = FROM
						}
					}
					50 = {
						modifier = {
							is_maimed_trigger = yes
							factor = 0
						}
						FROM = {
							random_list = {
								10 = { add_trait = disfigured }
								30 = { add_trait = one_eyed }
								30 = { add_trait = one_handed }
								30 = { add_trait = severely_injured }
							}
							clr_character_flag = target_for_mangekyo
						}
						death = {
							death_reason = death_murder_unknown killer = FROM
						}
					}
				}
			}
		}
    }
}	

character_event = {
	id = ACS.402
	picture = GFX_evt_yasaka_magatama
	is_triggered_only = yes	
	title = ACS.402.name

	desc = {
		trigger = {
			has_character_flag = get_mangekyo_by_love
		}
		text = EVTDESC_ACS401_A
	}

	desc = {
		trigger = {
			NOT = { has_character_flag = get_mangekyo_by_love }
		}
		text = EVTDESC_ACS401_B
	}

	option = {
		name = OK
		ai_chance = { factor = 100 }
	}
}


# ACS.00403 - Get a free contribution from a Vassal. Thanks sharingan
character_event = {
	id = ACS.00403
	desc = ACS_00403_DESC
	picture = GFX_evt_council
	
	only_playable = yes
	prisoner = no
	
	trigger = {
		OR = {
			trait = sharingan
			trait = mangekyo_sharingan
			trait = eternal_mangekyo_sharingan
		}
		NOT = { wealth = -50 }
		any_vassal = {
			wealth = 10
			NOT = { has_character_flag = took_extra_tax_sharingan }
		}
	}
	
	mean_time_to_happen = {
		months = 1
		modifier = {
			factor = 0.25
			has_character_flag = loan_taken_sharingan
		}
	}
	
	option = { # Ask one vassal for large
		name = EVTOPTA38010
		character_event = { id = ACS.00407 }
		trigger = {
			any_vassal = {
				wealth = 200
				NOT = { has_character_flag = took_extra_tax_sharingan }
			}
		}
		ai_chance = {
			factor = 10
		}
		random_vassal = {
			limit = {
				wealth = 200
				NOT = { has_character_flag = took_extra_tax_sharingan }
			}			
			set_character_flag = large_payment_from_vassal_sharingan
			character_event = { id = ACS.00404 days = 1 tooltip = EVTTOOLTIP38013 }
			set_character_flag = took_extra_tax_sharingan
		}
	}
	option = { # ask a vassals for medium
		name = EVTOPTC38010
		character_event = { id = ACS.00407 }
		trigger = {
			any_vassal = {
				wealth = 50
				NOT = { has_character_flag = took_extra_tax_sharingan }
				opinion = { who = ROOT value =  0 }
			}
		}

		ai_chance = {
			factor = 1
			modifier = {
				factor = 10
				wealth = -100
			}
		}
		random_vassal = {
			limit = {
				wealth = 25
				NOT = { has_character_flag = took_extra_tax_sharingan }
			}
			set_character_flag = medium_payment_from_vassal_sharingan
			character_event = { id = ACS.00404 days = 1 tooltip = EVTTOOLTIP38012 }
			set_character_flag = took_extra_tax_sharingan
		}
	}
	option = { # ask a vassal for small
		name = EVTOPTB38010
		character_event = { id = ACS.00407 }
		trigger = {
			any_vassal = {
				wealth = 10
				NOT = { has_character_flag = took_extra_tax_sharingan }
				opinion = { who = ROOT value =  0 }
			}
		}
		ai_chance = {
			factor = 1
		}
		random_vassal = {
			limit = {
				NOT = { has_character_flag = took_extra_tax_sharingan }
			}
			character_event = { id = ACS.00404 days = 1 tooltip = EVTTOOLTIP38011 }
			set_character_flag = small_payment_from_vassal_sharingan
			set_character_flag = took_extra_tax_sharingan
		}
	}
	option = { # I'm tired	
		name = ACS_00403_OPT_D	
		ai_chance = {
			factor = 1
			modifier = {
				factor = 100
				OR = {
					has_character_modifier = used_sharingan_3
					has_character_modifier = used_sharingan_4
					has_character_modifier = used_sharingan_5
				}
			}
		}		
	}
}

# ACS.00404 - The request
character_event = {
	id = ACS.00404
	desc = EVTDESC38011
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {
		name = ACCEPT
		ai_chance = {
			factor = 1
			modifier = {
				factor = 3
				OR = {
					NOT = { trait = sharingan }
					NOT = { trait = mangekyo_sharingan }
					NOT = { trait = byakugan }
					NOT = { trait = rinnegan }
				}
			}			
		}
		if = {
			limit = {
				has_character_flag = large_payment_from_vassal_sharingan
			}
			wealth = -250
		}
		if = {
			limit = {
				has_character_flag = medium_payment_from_vassal_sharingan
			}
			wealth = -50
		}
		if = {
			limit = {
				has_character_flag = small_payment_from_vassal_sharingan
			}
			wealth = -10
		}
		hidden_tooltip = {
			FROM = { character_event = { id = ACS.00406 days = 1 } }
		}
	}
	option = {
		name = DECLINE
		ai_chance = {
			factor = 1
			modifier = {
				factor = 3
				OR = {
					trait = sharingan
					trait = mangekyo_sharingan
					trait = byakugan
					trait = rinnegan
				}
			}
			modifier = {
				factor = 0
				OR = {
					NOT = { trait = sharingan }
					NOT = { trait = mangekyo_sharingan }
					NOT = { trait = byakugan }
					NOT = { trait = rinnegan }
				}
			}
		}
		clr_character_flag = small_payment_from_vassal_sharingan
		clr_character_flag = medium_payment_from_vassal_sharingan
		clr_character_flag = large_payment_from_vassal_sharingan
		
		reverse_opinion = {
			modifier = refused_money_request
			who = FROM
			years = 5
		}		
		hidden_tooltip = {
			FROM = { character_event = { id = ACS.00405 days = 1 } }
		}
	}
}

# ACS.00405 - REFUSAL TO PAY
character_event = {
	id = ACS.00405
	desc = EVTDESC38014
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {
		name = OK
		prestige = -1
	}
}

# ACS.00406 - Payment accepted
character_event = {
	id = ACS.00406
	desc = EVTDESC38015
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {
		name = OK
		if = {
			limit = {
				FROM = { has_character_flag = large_payment_from_vassal_sharingan }
			}
			wealth = 250
		}
		if = {
			limit = {
				FROM = { has_character_flag = medium_payment_from_vassal_sharingan }
			}
			wealth = 50
		}
		if = {
			limit = {
				FROM = { has_character_flag = small_payment_from_vassal_sharingan }
			}
			wealth = 10
		}
		FROM = {
			clr_character_flag = small_payment_from_vassal_sharingan
			clr_character_flag = medium_payment_from_vassal_sharingan
			clr_character_flag = large_payment_from_vassal_sharingan
		}
		prestige = 1
	}	
}

# ACS.00407 - Controls Sharingan fatigue
character_event = {
	id = ACS.00407
	hide_window = yes	
	is_triggered_only = yes

	trigger = {
		OR = {
			trait = sharingan
			trait = mangekyo_sharingan
		}
	}

	immediate = {
		if = {
			limit = {
				has_character_modifier = used_sharingan_4
			}
			remove_character_modifier = used_sharingan_4
			add_character_modifier = {
				name = used_sharingan_5
				duration = 960
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_3
			}
			remove_character_modifier = used_sharingan_3
			add_character_modifier = {
				name = used_sharingan_4
				duration = 480
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_2
			}
			remove_character_modifier = used_sharingan_2
			add_character_modifier = {
				name = used_sharingan_3
				duration = 240
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_1
			}
			remove_character_modifier = used_sharingan_1
			add_character_modifier = {
				name = used_sharingan_2
				duration = 120
			}
			break = yes
		}
		add_character_modifier = {
			name = used_sharingan_1
			duration = 60
		}
	}
}

# ACS.00408 - Init Mangekyo attack for ia
character_event = {
	id = ACS.00408
	hide_window = yes	

	trigger = {
		ai = yes
		trait = sharingan
		trait = ambitious
		NOT = { trait = mangekyo_sharingan }
		NOT = { trait = eternal_mangekyo_sharingan }
		age >= 16
		OR = {
			num_of_lovers >= 1
			num_of_friends >= 1
		}
		is_pregnant = no
		NOT = { has_character_modifier = recent_duel_timer }
	}

	mean_time_to_happen = {
		months = 1
		modifier = {
			factor = 0.5
			trait = brave
		}
		modifier = {
			factor = 100
			trait = craven
		}
		modifier = {
			factor = 5
			religion = buddhist
		}
	}

	immediate = {
		ROOT = {
			save_event_target_as = combatant_1
		}
		# Select the target of duel
		if = {
			limit = {
				num_of_lovers >= 1
			}
			random_lover = {
				save_event_target_as = combatant_2
				apply_degree_of_dishonorable_duel_effect = yes
				apply_any_applicable_harsh_penalties_effect = yes
			}
			ROOT = {
				pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	            	hidden = yes
	            }
			}
			event_target:combatant_2 = { character_event = { id = ACS.00409 } }
			break = yes
		}
		if = {
			limit = {
				num_of_friends >= 1
			}
			random_friend = {
				save_event_target_as = combatant_2
				apply_degree_of_dishonorable_duel_effect = yes
				apply_any_applicable_harsh_penalties_effect = yes
			}
			ROOT = {
				pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	                hidden = yes
	            }
			}
			event_target:combatant_2 = { character_event = { id = ACS.00409 } }
			break = yes
		}
	}
}


### "REGULAR" duels start here...
# Get challenged (sent from duel_decision )
character_event = {
    id = ACS.00409 # HFP.10095
    picture = GFX_evt_armory
    border = GFX_event_normal_frame_war    
    desc = ACS_00409_DESC
	is_triggered_only = yes
    
    immediate = {
        if = {
            limit = { NOT = { has_character_modifier = recent_duel_timer } }
            add_character_modifier = {
                modifier = recent_duel_timer
                hidden = yes
                months = 3
            }
        }
        event_target:combatant_1 = { #combatant_1/attacker
            if = {
                limit = { NOT = { has_character_modifier = recent_duel_timer } }
                #special circumstances, like initiation duel, etc
                add_character_modifier = { #OUTCOMMENT FOR TESTING PURPOSES
                    modifier = recent_duel_timer
                    hidden = yes
                    months = 3
                }
            }
        }
    }
    
    option = { #Challenge accepted
        name = EVTOPTA_WOL_11000
        clr_character_flag = flag_duel_no_backsies
        ai_chance = {
            factor = 100
        }

        pacifists_lose_piety_effect = yes
        event_target:combatant_1 = {
            character_event = { id = HFP.10096 }
        }
        set_character_flag = add_duel_xp
        clr_character_flag = punish_declining
        ai_chance = {
            factor = 80
        }
    }    
}
