NAMESPACE = ACS

# ACS.00400 - Decision to enable the mangekyo
narrative_event = {
	id = ACS.00400
	title = ACS_00400_TITLE
	desc = ACS_00400_DESC
	picture = GFX_evt_yasaka_magatama

	trigger = {
		OR = {
			ai = no
			AND = {
				ai = yes
				trait = ambitious				
			}
		}
		trait = sharingan
		NOR = {
			trait = mangekyo_sharingan
			trait = eternal_mangekyo_sharingan
			has_character_modifier = recent_duel_timer
			has_character_flag = never_wants_mangekyo
			trait = craven
			trait = weak
		}
		age >= 16
		OR = {
			num_of_lovers >= 1
			num_of_friends >= 1
		}
		is_pregnant = no
		is_inaccessible_or_incapable_trigger = no
	}

	mean_time_to_happen = {
		months = 12
		modifier = {
			factor = 0.5
			trait = brave
		}		
		modifier = {
			factor = 5
			religion = buddhist
		}
		modifier = {
			factor = 3
			has_character_flag = not_ready_for_mangekyo
		}
	}

	option = {
		name = ACS_00400_OPT_A # Accepts
		ai_chance = {
			factor = 100
		}

		ROOT = {
			save_event_target_as = combatant_1
			set_character_flag = flag_duel_no_draws
		}
		# Select the target of duel
		if = {
			limit = {
				num_of_lovers >= 1
			}
			random_lover = {
				limit = {
					NOR = {
						trait = craven
						trait = weak
					}
				}
				save_event_target_as = combatant_2
				set_character_flag = flag_duel_no_draws				
				
			}
			ROOT = {
				pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	            	hidden = yes
	            }
			}
			event_target:combatant_2 = { character_event = { id = ACS.00409 } }
			break = yes
		}
		if = {
			limit = {
				num_of_friends >= 1
			}
			random_friend = {
				limit = {
					NOR = {
						trait = craven
						trait = weak
					}
				}
				save_event_target_as = combatant_2
				set_character_flag = flag_duel_no_draws
			}
			ROOT = {
				pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	                hidden = yes
	            }
			}
			event_target:combatant_2 = { character_event = { id = ACS.00409 } }
			break = yes
		}
	}
	option = {
		name = ACS_00400_OPT_B # Not ready yet

		ai_chance = {
			factor = 1
		}

		set_character_flag = not_ready_for_mangekyo
	}
	option = {
		name = ACS_00400_OPT_C # I dont want this eyes

		ai_chance = {
			factor = 1
		}

		set_character_flag = never_wants_mangekyo
	}	
}

# ACS.00401 - Khalga traveling every year
character_event = {
	id = ACS.00401
	is_triggered_only = yes
	hide_window = yes
	has_character_flag = is_khalga
	min_age = 16

	immediate = {
		character_event = { id = ACS.00201 }
	}
}

# ACS.00402 - Displays the get sharingan for the attacker
narrative_event = {
	id = ACS.00402
	picture = GFX_evt_yasaka_magatama
	is_triggered_only = yes	
	title = ACS_00402_TITLE
	desc = ACS_00402_DESC

	trigger = {
		is_alive = yes
	}	

	option = {
		name = OK
		remove_trait = sharingan
		add_trait = mangekyo_sharingan
		random_list = {
			50 = {
				add_character_modifier = {
					name = amaterasu
					duration = -1
				}
			}
			50 = {
				add_character_modifier = {
					name = tsukuyomi
					duration = -1
				}
			}
		}
		ai_chance = { factor = 100 }
	}
}

# ACS.00407 - Controls Sharingan fatigue
character_event = {
	id = ACS.00407
	hide_window = yes	
	is_triggered_only = yes

	trigger = {
		OR = {
			trait = sharingan
			trait = mangekyo_sharingan
		}
	}

	immediate = {
		if = {
			limit = {
				has_character_modifier = used_sharingan_4
			}
			remove_character_modifier = used_sharingan_4
			add_character_modifier = {
				name = used_sharingan_5
				duration = 5760
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_3
			}
			remove_character_modifier = used_sharingan_3
			add_character_modifier = {
				name = used_sharingan_4
				duration = 2880
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_2
			}
			remove_character_modifier = used_sharingan_2
			add_character_modifier = {
				name = used_sharingan_3
				duration = 1440
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_1
			}
			remove_character_modifier = used_sharingan_1
			add_character_modifier = {
				name = used_sharingan_2
				duration = 720
			}
			break = yes
		}
		add_character_modifier = {
			name = used_sharingan_1
			duration = 360
		}
	}
}

### "REGULAR" duels start here...
# Get challenged (sent from duel_decision )
character_event = {
    id = ACS.00409 # HFP.10095
    picture = GFX_evt_armory
    border = GFX_event_normal_frame_war    
    desc = ACS_00409_DESC
	is_triggered_only = yes
    
    immediate = {
        if = {
            limit = { NOT = { has_character_modifier = recent_duel_timer } }
            add_character_modifier = {
                modifier = recent_duel_timer
                hidden = yes
                months = 3
            }
        }
        event_target:combatant_1 = { #combatant_1/attacker
            if = {
                limit = { NOT = { has_character_modifier = recent_duel_timer } }
                #special circumstances, like initiation duel, etc
                add_character_modifier = { #OUTCOMMENT FOR TESTING PURPOSES
                    modifier = recent_duel_timer
                    hidden = yes
                    months = 3
                }
            }
        }
    }
    
    option = { #Challenge accepted
        name = EVTOPTA_WOL_11000
        clr_character_flag = flag_duel_no_backsies
        ai_chance = {
            factor = 100
        }

         event_target:combatant_1 = {
            character_event = { id = ACS.00410 }
        }
        set_character_flag = add_duel_xp
        clr_character_flag = punish_declining
        ai_chance = {
            factor = 80
        }
    }    
}

#  ACS.00410 - Start the duel - For the attacker (combatant_1)
character_event = {
    id =  ACS.00410 # HFP.10096
    is_triggered_only = yes
    picture = GFX_evt_armory
    border = GFX_event_normal_frame_war
    desc = EVTDESC_HFP_10096_bloodline
    
    option = {
        name = EVTOPTA_WOL_11001
        #FALLBACK:
        if = { #If FROM is no longer alive, clear relevant flags, etc...
            limit = { FROM = { NOT = { is_alive = yes } } }
            reset_warrior_lodge_joining_chain_effect = yes
            character_event = { id = HFP.10197 }
        }
        else = {
            hidden_effect = {
                set_character_flag = add_duel_xp
                reset_duel_timers_effect = yes
                character_event = { id = HFP.10100 } #Send hidden set-up of duel (from there: result)
				narrative_event = { id = ACS.00402 days = 3 }
            }
        }
        ai_chance = {
            factor = 100
        }
    }    
}
