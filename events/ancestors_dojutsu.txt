NAMESPACE = ACS

# ACS.00400 - Decision to enable the mangekyo
narrative_event = {
	id = ACS.00400
	title = ACS_00400_TITLE
	desc = ACS_00400_DESC
	picture = GFX_evt_yasaka_magatama

	trigger = {
		ai = no
		trait = sharingan
		NOR = {
			trait = mangekyo_sharingan
			trait = eternal_mangekyo_sharingan
			has_character_modifier = recent_duel_timer
			has_character_flag = never_wants_mangekyo
		}
		age >= 16
		OR = {
			num_of_lovers >= 1
			num_of_friends >= 1
		}
		is_pregnant = no
		is_inaccessible_or_incapable_trigger = no
	}


	mean_time_to_happen = {
		months = 12
		modifier = {
			factor = 0.5
			trait = brave
		}		
		modifier = {
			factor = 5
			religion = buddhist
		}
		modifier = {
			factor = 3
			has_character_flag = not_ready_for_mangekyo
		}
	}

	option = {
		name = ACS_00400_OPT_A # Accepts
		ROOT = {
			save_event_target_as = combatant_1
			set_character_flag = flag_duel_no_draws
		}
		# Select the target of duel
		if = {
			limit = {
				num_of_lovers >= 1
			}
			random_lover = {
				limit = {
					NOR = {
						trait = craven
						trait = weak
					}
				}
				save_event_target_as = combatant_2
				set_character_flag = flag_duel_no_draws				
				
			}
			ROOT = {
				pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	            	hidden = yes
	            }
			}
			event_target:combatant_2 = { character_event = { id = ACS.00409 } }
			break = yes
		}
		if = {
			limit = {
				num_of_friends >= 1
			}
			random_friend = {
				limit = {
					NOR = {
						trait = craven
						trait = weak
					}
				}
				save_event_target_as = combatant_2
				set_character_flag = flag_duel_no_draws
			}
			ROOT = {
				pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	                hidden = yes
	            }
			}
			event_target:combatant_2 = { character_event = { id = ACS.00409 } }
			break = yes
		}
	}
	option = {
		name = ACS_00400_OPT_B # Not ready yet
		set_character_flag = not_ready_for_mangekyo
	}
	option = {
		name = ACS_00400_OPT_C # I dont want this eyes
		set_character_flag = never_wants_mangekyo
	}	
}

# ACS.00401 - Khalga traveling every year
character_event = {
	id = ACS.00401
	is_triggered_only = yes
	hide_window = yes
	has_character_flag = is_khalga
	min_age = 16

	immediate = {
		character_event = { id = ACS.00201 }
	}
}

# ACS.00402 - Displays the get sharingan for the attacker
narrative_event = {
	id = ACS.00402
	picture = GFX_evt_yasaka_magatama
	is_triggered_only = yes	
	title = ACS_00402_TITLE
	desc = ACS_00402_DESC

	trigger = {
		is_alive = yes
	}	

	option = {
		name = OK
		remove_trait = sharingan
		add_trait = mangekyo_sharingan
		ai_chance = { factor = 100 }
	}
}

# ACS.00403 - Get a free contribution from a Vassal. Thanks sharingan
character_event = {
	id = ACS.00403
	desc = ACS_00403_DESC
	picture = GFX_evt_council
	
	only_playable = yes
	prisoner = no
	
	trigger = {
		OR = {
			trait = sharingan
			trait = mangekyo_sharingan
			trait = eternal_mangekyo_sharingan
		}
		NOT = { wealth = -50 }
		any_vassal = {
			wealth = 10
			NOT = { has_character_flag = took_extra_tax_sharingan }
		}
	}
	
	mean_time_to_happen = {
		months = 1
		modifier = {
			factor = 0.25
			has_character_flag = loan_taken_sharingan
		}
	}
	
	option = { # Ask one vassal for large
		name = EVTOPTA38010
		character_event = { id = ACS.00407 }
		trigger = {
			any_vassal = {
				wealth = 200
				NOT = { has_character_flag = took_extra_tax_sharingan }
			}
		}
		ai_chance = {
			factor = 10
		}
		random_vassal = {
			limit = {
				wealth = 200
				NOT = { has_character_flag = took_extra_tax_sharingan }
			}			
			set_character_flag = large_payment_from_vassal_sharingan
			character_event = { id = ACS.00404 days = 1 tooltip = EVTTOOLTIP38013 }
			set_character_flag = took_extra_tax_sharingan
		}
	}
	option = { # ask a vassals for medium
		name = EVTOPTC38010
		character_event = { id = ACS.00407 }
		trigger = {
			any_vassal = {
				wealth = 50
				NOT = { has_character_flag = took_extra_tax_sharingan }
				opinion = { who = ROOT value =  0 }
			}
		}

		ai_chance = {
			factor = 1
			modifier = {
				factor = 10
				wealth = -100
			}
		}
		random_vassal = {
			limit = {
				wealth = 25
				NOT = { has_character_flag = took_extra_tax_sharingan }
			}
			set_character_flag = medium_payment_from_vassal_sharingan
			character_event = { id = ACS.00404 days = 1 tooltip = EVTTOOLTIP38012 }
			set_character_flag = took_extra_tax_sharingan
		}
	}
	option = { # ask a vassal for small
		name = EVTOPTB38010
		character_event = { id = ACS.00407 }
		trigger = {
			any_vassal = {
				wealth = 10
				NOT = { has_character_flag = took_extra_tax_sharingan }
				opinion = { who = ROOT value =  0 }
			}
		}
		ai_chance = {
			factor = 1
		}
		random_vassal = {
			limit = {
				NOT = { has_character_flag = took_extra_tax_sharingan }
			}
			character_event = { id = ACS.00404 days = 1 tooltip = EVTTOOLTIP38011 }
			set_character_flag = small_payment_from_vassal_sharingan
			set_character_flag = took_extra_tax_sharingan
		}
	}
	option = { # I'm tired	
		name = ACS_00403_OPT_D	
		ai_chance = {
			factor = 1
			modifier = {
				factor = 100
				OR = {
					has_character_modifier = used_sharingan_3
					has_character_modifier = used_sharingan_4
					has_character_modifier = used_sharingan_5
				}
			}
		}		
	}
}

# ACS.00404 - The request
character_event = {
	id = ACS.00404
	desc = EVTDESC38011
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {
		name = ACCEPT
		ai_chance = {
			factor = 1
			modifier = {
				factor = 3
				OR = {
					NOT = { trait = sharingan }
					NOT = { trait = mangekyo_sharingan }
					NOT = { trait = byakugan }
					NOT = { trait = rinnegan }
				}
			}			
		}
		if = {
			limit = {
				has_character_flag = large_payment_from_vassal_sharingan
			}
			wealth = -250
		}
		if = {
			limit = {
				has_character_flag = medium_payment_from_vassal_sharingan
			}
			wealth = -50
		}
		if = {
			limit = {
				has_character_flag = small_payment_from_vassal_sharingan
			}
			wealth = -10
		}
		hidden_tooltip = {
			FROM = { character_event = { id = ACS.00406 days = 1 } }
		}
	}
	option = {
		name = DECLINE
		ai_chance = {
			factor = 1
			modifier = {
				factor = 3
				OR = {
					trait = sharingan
					trait = mangekyo_sharingan
					trait = byakugan
					trait = rinnegan
				}
			}
			modifier = {
				factor = 0
				OR = {
					NOT = { trait = sharingan }
					NOT = { trait = mangekyo_sharingan }
					NOT = { trait = byakugan }
					NOT = { trait = rinnegan }
				}
			}
		}
		clr_character_flag = small_payment_from_vassal_sharingan
		clr_character_flag = medium_payment_from_vassal_sharingan
		clr_character_flag = large_payment_from_vassal_sharingan
		
		reverse_opinion = {
			modifier = refused_money_request
			who = FROM
			years = 5
		}		
		hidden_tooltip = {
			FROM = { character_event = { id = ACS.00405 days = 1 } }
		}
	}
}

# ACS.00405 - REFUSAL TO PAY
character_event = {
	id = ACS.00405
	desc = EVTDESC38014
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {
		name = OK
		prestige = -1
	}
}

# ACS.00406 - Payment accepted
character_event = {
	id = ACS.00406
	desc = EVTDESC38015
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {
		name = OK
		if = {
			limit = {
				FROM = { has_character_flag = large_payment_from_vassal_sharingan }
			}
			wealth = 250
		}
		if = {
			limit = {
				FROM = { has_character_flag = medium_payment_from_vassal_sharingan }
			}
			wealth = 50
		}
		if = {
			limit = {
				FROM = { has_character_flag = small_payment_from_vassal_sharingan }
			}
			wealth = 10
		}
		FROM = {
			clr_character_flag = small_payment_from_vassal_sharingan
			clr_character_flag = medium_payment_from_vassal_sharingan
			clr_character_flag = large_payment_from_vassal_sharingan
		}
		prestige = 1
	}	
}

# ACS.00407 - Controls Sharingan fatigue
character_event = {
	id = ACS.00407
	hide_window = yes	
	is_triggered_only = yes

	trigger = {
		OR = {
			trait = sharingan
			trait = mangekyo_sharingan
		}
	}

	immediate = {
		if = {
			limit = {
				has_character_modifier = used_sharingan_4
			}
			remove_character_modifier = used_sharingan_4
			add_character_modifier = {
				name = used_sharingan_5
				duration = 960
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_3
			}
			remove_character_modifier = used_sharingan_3
			add_character_modifier = {
				name = used_sharingan_4
				duration = 480
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_2
			}
			remove_character_modifier = used_sharingan_2
			add_character_modifier = {
				name = used_sharingan_3
				duration = 240
			}
			break = yes
		}
		if = {
			limit = {
				has_character_modifier = used_sharingan_1
			}
			remove_character_modifier = used_sharingan_1
			add_character_modifier = {
				name = used_sharingan_2
				duration = 120
			}
			break = yes
		}
		add_character_modifier = {
			name = used_sharingan_1
			duration = 60
		}
	}
}

# ACS.00408 - Init Mangekyo attack for ia
character_event = {
	id = ACS.00408
	hide_window = yes	

	trigger = {
		ai = yes
		trait = sharingan
		trait = ambitious
		NOR = {
			trait = weak
			trait = craven
			trait = mangekyo_sharingan
			trait = eternal_mangekyo_sharingan
			has_character_modifier = recent_duel_timer
		}
		age >= 16
		OR = {
			num_of_lovers >= 1
			num_of_friends >= 1
		}
		is_pregnant = no
		NOT = { has_character_modifier = recent_duel_timer }
		is_inaccessible_or_incapable_trigger = no
	}

	mean_time_to_happen = {
		months = 12
		modifier = {
			factor = 0.5
			trait = brave
		}		
		modifier = {
			factor = 5
			religion = buddhist
		}
	}

	immediate = {
		ROOT = {
			save_event_target_as = combatant_1
			set_character_flag = flag_duel_no_draws
		}
		# Select the target of duel
		if = {
			limit = {
				num_of_lovers >= 1
			}
			random_lover = {
				limit = {
					NOR = {
						trait = craven
						trait = weak
					}
				}
				save_event_target_as = combatant_2
				set_character_flag = flag_duel_no_draws				
				
			}
			ROOT = {
				pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	            	hidden = yes
	            }
			}
			event_target:combatant_2 = { character_event = { id = ACS.00409 } }
			break = yes
		}
		if = {
			limit = {
				num_of_friends >= 1
			}
			random_friend = {
				limit = {
					NOR = {
						trait = craven
						trait = weak
					}
				}
				save_event_target_as = combatant_2
				set_character_flag = flag_duel_no_draws
			}
			ROOT = {
				pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	                hidden = yes
	            }
			}
			event_target:combatant_2 = { character_event = { id = ACS.00409 } }
			break = yes
		}
	}
}


### "REGULAR" duels start here...
# Get challenged (sent from duel_decision )
character_event = {
    id = ACS.00409 # HFP.10095
    picture = GFX_evt_armory
    border = GFX_event_normal_frame_war    
    desc = ACS_00409_DESC
	is_triggered_only = yes
    
    immediate = {
        if = {
            limit = { NOT = { has_character_modifier = recent_duel_timer } }
            add_character_modifier = {
                modifier = recent_duel_timer
                hidden = yes
                months = 3
            }
        }
        event_target:combatant_1 = { #combatant_1/attacker
            if = {
                limit = { NOT = { has_character_modifier = recent_duel_timer } }
                #special circumstances, like initiation duel, etc
                add_character_modifier = { #OUTCOMMENT FOR TESTING PURPOSES
                    modifier = recent_duel_timer
                    hidden = yes
                    months = 3
                }
            }
        }
    }
    
    option = { #Challenge accepted
        name = EVTOPTA_WOL_11000
        clr_character_flag = flag_duel_no_backsies
        ai_chance = {
            factor = 100
        }

         event_target:combatant_1 = {
            character_event = { id = ACS.00410 }
        }
        set_character_flag = add_duel_xp
        clr_character_flag = punish_declining
        ai_chance = {
            factor = 80
        }
    }    
}

#  ACS.00410 - Start the duel - For the attacker (combatant_1)
character_event = {
    id =  ACS.00410 # HFP.10096
    is_triggered_only = yes
    picture = GFX_evt_armory
    border = GFX_event_normal_frame_war
    desc = EVTDESC_HFP_10096_bloodline
    
    option = {
        name = EVTOPTA_WOL_11001
        #FALLBACK:
        if = { #If FROM is no longer alive, clear relevant flags, etc...
            limit = { FROM = { NOT = { is_alive = yes } } }
            reset_warrior_lodge_joining_chain_effect = yes
            character_event = { id = HFP.10197 }
        }
        else = {
            hidden_effect = {
                set_character_flag = add_duel_xp
                reset_duel_timers_effect = yes
                character_event = { id = HFP.10100 } #Send hidden set-up of duel (from there: result)
				narrative_event = { id = ACS.00402 days = 3 }
            }
        }
        ai_chance = {
            factor = 100
        }
    }    
}
